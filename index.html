<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>請求書アップロード</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root { --safe-bottom: env(safe-area-inset-bottom, 0px); }

    /* === ラバー無効 & レイアウト固定 === */
    html, body { height: 100%; overscroll-behavior: none; }
    body {
      position: fixed; inset: 0;             /* 画面に固定（ビヨン防止） */
      overflow: hidden;                       /* bodyはスクロールさせない */
      background: #f1f5f9;                    /* slate-100 */
    }
  </style>
</head>
<body>
  <!-- ヘッダー（角丸なし・影なし） -->
  <header class="bg-[#06C755] text-white px-4 pt-6 pb-3">
    <h1 class="text-base font-semibold">請求書アップロード</h1>
  </header>

  <!-- 本文：ここだけ縦スクロール可能。ラバー対策に overscroll-contain -->
  <main class="h-[calc(100svh-64px)] overflow-y-auto overscroll-contain pb-[96px] px-4">
    <!-- 対象レコード -->
    <section class="bg-white p-4 rounded-lg">
      <h2 class="font-semibold">対象レコード</h2>
      <div id="recordSummary" class="text-sm text-slate-600 mt-1"></div>
      <button id="openRecordList" type="button"
        class="mt-2 px-4 py-2 rounded bg-emerald-600 text-white font-medium">
        選択
      </button>
      <input type="hidden" id="recordId" />
    </section>

    <!-- 請求書ファイル -->
    <section class="bg-white p-4 rounded-lg mt-4">
      <h3 class="font-semibold">請求書ファイル</h3>
      <input id="invoiceFile" type="file" accept="application/pdf,image/*"
        class="h-11 px-3 mt-2 rounded border bg-white file:mr-3 file:px-3 file:py-2 file:rounded file:border file:bg-slate-100 w-full" />
    </section>
  </main>

  <!-- 固定フッター（画面幅いっぱい・セーフエリア考慮） -->
  <div class="fixed inset-x-0 bottom-0 bg-white">
    <div class="px-4 pt-2 pb-[calc(8px+var(--safe-bottom))]">
      <button id="submit" class="w-full h-12 rounded bg-emerald-600 text-white font-semibold">
        アップロード
      </button>
    </div>
  </div>

  <!-- モーダル（中身だけスクロール・ミニスピナー） -->
  <div id="recordModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white w-[92%] max-w-md rounded-lg p-4 max-h-[80vh] overflow-y-auto overscroll-contain">
      <h3 class="font-semibold text-lg mb-3">レコードを選択</h3>
      <div id="recordList" class="space-y-2"></div>
      <button id="closeModal" class="mt-4 w-full py-2 rounded border">閉じる</button>
    </div>
  </div>

  <!-- 全画面スピナー（アップロード時のみ使用） -->
  <div id="spinner" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white"></div>
  </div>

<script>
const LIFF_ID = "2008144627-bOAmoQo0";  // ← あなたの LIFF ID
const SEARCH_ENDPOINT = "/api/search";
const ATTACH_ENDPOINT = "/api/invoice-attach";

/* スピナー（アップロード用） */
function showSpinner(){ document.getElementById("spinner").classList.remove("hidden"); }
function hideSpinner(){ document.getElementById("spinner").classList.add("hidden"); }

/* レコード取得 */
async function fetchRecords(uid) {
  if (!uid) return [];
  const res = await fetch(`${SEARCH_ENDPOINT}?uid=${encodeURIComponent(uid)}`);
  let data = {};
  try { data = await res.json(); } catch {}
  return Array.isArray(data.records) ? data.records : [];
}

function renderRecordList(records) {
  const wrap = document.getElementById("recordList");
  wrap.innerHTML = "";
  if (!records.length) {
    wrap.innerHTML = "<p class='text-sm text-slate-500 text-center py-4'>対象レコードはありません</p>";
    return;
  }
  records.forEach(r => {
    const card = document.createElement("button");
    card.type = "button";
    card.className = "w-full text-left p-3 rounded border hover:bg-slate-50";

    const date = r.baseDate || "-";
    const itemsPreview = r.itemTable.slice(0, 2).map(it => {
      const lots = (it.designLot || []).join(",");
      return `${it.itemName} × ${it.qty}${lots ? " [" + lots + "]" : ""}`;
    });
    const more = r.itemTable.length > 2 ? ` 他${r.itemTable.length - 2}件` : "";

    card.innerHTML = `
      <div class="font-semibold text-sm">#${r.recordId}　入荷予定日: ${date}</div>
      <div class="text-xs text-slate-600 mt-1">${itemsPreview.join(" / ")}${more}</div>
    `;
    card.addEventListener("click", () => {
      document.getElementById("recordId").value = r.recordId;
      document.getElementById("recordSummary").textContent =
        `#${r.recordId} / 入荷予定日:${date} / ${itemsPreview.join(" / ")}${more}`;
      closeModal();
    });
    wrap.appendChild(card);
  });
}

/* モーダル：ミニスピナーを中に表示 */
const modal = document.getElementById("recordModal");
document.getElementById("openRecordList").addEventListener("click", async () => {
  modal.classList.remove("hidden");
  const listWrap = document.getElementById("recordList");
  listWrap.innerHTML = `
    <div class="flex flex-col items-center justify-center py-6 text-slate-500">
      <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-emerald-600"></div>
      <p class="mt-2 text-sm">読み込み中...</p>
    </div>
  `;
  try {
    if (!window._uid) await initUid();
    const recs = await fetchRecords(window._uid);
    renderRecordList(recs);
  } catch (e) {
    console.warn(e);
    listWrap.innerHTML = "<p class='text-sm text-rose-600 text-center py-4'>読み込みに失敗しました。再度お試しください。</p>";
  }
});
document.getElementById("closeModal").addEventListener("click", closeModal);
function closeModal(){ modal.classList.add("hidden"); }

/* 送信（アップロード中は全画面スピナー） */
document.getElementById("submit").addEventListener("click", async () => {
  const recId = document.getElementById("recordId").value;
  const file = document.getElementById("invoiceFile").files[0];
  if (!recId){ alert("レコードを選択してください"); return; }
  if (!file){ alert("ファイルを選択してください"); return; }

  showSpinner();

  const fd = new FormData();
  fd.append("recordId", recId);
  fd.append("file", file, file.name);

  try {
    const res = await fetch(ATTACH_ENDPOINT, { method:"POST", body: fd });
    if (res.ok) {
      alert("アップロードしました");
      document.getElementById("invoiceFile").value = "";
      document.getElementById("recordSummary").textContent = "";
      document.getElementById("recordId").value = "";
    } else {
      alert("アップロード失敗: " + (await res.text()));
    }
  } catch (err) {
    alert("エラー: " + err.message);
  } finally {
    hideSpinner();
  }
});

/* UID 初期化 */
async function initUid(){
  const qsUid = new URLSearchParams(location.search).get("uid");
  if (qsUid){ window._uid = qsUid; return; }
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()){
      liff.login({ redirectUri: location.href });
      return;
    }
    const profile = await liff.getProfile();
    window._uid = profile.userId;
  } catch(e){
    console.warn("LIFF UID取得失敗。開発中は ?uid=xxx をURLに付けてください", e);
    window._uid = null;
  }
}
initUid();
</script>
</body>
</html>
