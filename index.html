<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>è«‹æ±‚æ›¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body class="grid place-items-center p-3 bg-slate-100">
  <div class="phone-frame flex flex-col bg-white rounded-2xl shadow-lg w-[390px] max-w-full h-[844px]">
    <header class="ios-safe bg-[#06C755] text-white px-4 pb-3 pt-6 rounded-t-2xl">
      <h1 class="text-base font-semibold">è«‹æ±‚æ›¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h1>
    </header>

    <main class="flex-1 overflow-y-auto bg-slate-50 p-4 pb-28 space-y-4">
      <!-- å¯¾è±¡ãƒ¬ã‚³ãƒ¼ãƒ‰ -->
      <section class="bg-white p-4 rounded-2xl shadow-sm">
        <h2 class="font-semibold">å¯¾è±¡ãƒ¬ã‚³ãƒ¼ãƒ‰</h2>
        <div id="recordSummary" class="text-sm text-slate-600 mt-1"></div>
        <button id="openRecordList" type="button"
          class="mt-2 px-4 py-2 rounded-lg bg-emerald-600 text-white font-medium">
          é¸æŠ
        </button>
        <input type="hidden" id="recordId" />
      </section>

      <!-- è«‹æ±‚æ›¸ãƒ•ã‚¡ã‚¤ãƒ« -->
      <section class="bg-white p-4 rounded-2xl shadow-sm">
        <h3 class="font-semibold">è«‹æ±‚æ›¸ãƒ•ã‚¡ã‚¤ãƒ«</h3>
        <input id="invoiceFile" type="file" accept="application/pdf,image/*"
          class="h-11 px-3 mt-2 rounded-xl border bg-white file:mr-3 file:px-3 file:py-2 file:rounded-lg file:border file:bg-slate-100" />
      </section>
    </main>

    <!-- é€ä¿¡ãƒœã‚¿ãƒ³ -->
    <div class="fixed bottom-0 left-1/2 -translate-x-1/2 w-[390px] max-w-[100vw] bg-white p-2 rounded-b-2xl">
      <button id="submit" class="w-full h-12 rounded-xl bg-emerald-600 text-white font-semibold">
        ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      </button>
    </div>
  </div>

  <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="recordModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white w-[90%] max-w-lg rounded-xl shadow-lg p-4 max-h-[80vh] overflow-y-auto">
      <h3 class="font-semibold text-lg mb-3">ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’é¸æŠ</h3>
      <div id="recordList" class="space-y-2"></div>
      <button id="closeModal" class="mt-4 w-full py-2 rounded-lg border">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <!-- å…¨ç”»é¢ã‚¹ãƒ”ãƒŠãƒ¼ï¼ˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨ã®ã¿ï¼‰ -->
  <div id="spinner" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white"></div>
  </div>

<script>
const LIFF_ID = "2008144627-bOAmoQo0";  // â† ã‚ãªãŸã® LIFF ID
const SEARCH_ENDPOINT = "/api/search";
const ATTACH_ENDPOINT = "/api/invoice-attach";

// ==== ã‚¹ãƒ”ãƒŠãƒ¼åˆ¶å¾¡ï¼ˆå…¨ç”»é¢ï¼šã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨ï¼‰ ====
function showSpinner() {
  document.getElementById("spinner").classList.remove("hidden");
}
function hideSpinner() {
  document.getElementById("spinner").classList.add("hidden");
}

// ==== ãƒ¬ã‚³ãƒ¼ãƒ‰å–å¾— ====
async function fetchRecords(uid) {
  if (!uid) return [];
  const res = await fetch(`${SEARCH_ENDPOINT}?uid=${encodeURIComponent(uid)}`);
  let data = {};
  try { data = await res.json(); } catch {}
  return Array.isArray(data.records) ? data.records : [];
}

function renderRecordList(records) {
  const wrap = document.getElementById("recordList");
  wrap.innerHTML = "";
  if (!records.length) {
    wrap.innerHTML = "<p class='text-sm text-slate-500 text-center py-4'>å¯¾è±¡ãƒ¬ã‚³ãƒ¼ãƒ‰ã¯ã‚ã‚Šã¾ã›ã‚“</p>";
    return;
  }
  records.forEach(r => {
    const card = document.createElement("button");
    card.type = "button";
    card.className = "w-full text-left p-3 rounded-lg border hover:bg-slate-50";
    const date = r.baseDate || "-";
    const itemsPreview = r.itemTable.slice(0,2).map(it => {
      const lots = (it.designLot || []).join(",");
      return `${it.itemName} Ã— ${it.qty}${lots ? " ["+lots+"]":""}`;
    });
    const more = r.itemTable.length > 2 ? ` ä»–${r.itemTable.length-2}ä»¶` : "";
    card.innerHTML = `
      <div class="font-semibold text-sm">#${r.recordId}ã€€å…¥è·äºˆå®šæ—¥: ${date}</div>
      <div class="text-xs text-slate-600 mt-1">${itemsPreview.join(" / ")}${more}</div>
    `;
    card.addEventListener("click", () => {
      document.getElementById("recordId").value = r.recordId;
      document.getElementById("recordSummary").textContent =
        `#${r.recordId} / å…¥è·äºˆå®šæ—¥:${date} / ${itemsPreview.join(" / ")}${more}`;
      closeModal();
    });
    wrap.appendChild(card);
  });
}

// ==== ãƒ¢ãƒ¼ãƒ€ãƒ« ====
const modal = document.getElementById("recordModal");
document.getElementById("openRecordList").addEventListener("click", async () => {
  modal.classList.remove("hidden");

  const listWrap = document.getElementById("recordList");
  // ğŸ”½ ãƒ¢ãƒ¼ãƒ€ãƒ«å†…å°‚ç”¨ãƒŸãƒ‹ã‚¹ãƒ”ãƒŠãƒ¼ã‚’è¡¨ç¤º
  listWrap.innerHTML = `
    <div class="flex flex-col items-center justify-center py-6 text-slate-500">
      <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-emerald-600"></div>
      <p class="mt-2 text-sm">èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>
  `;

  try {
    if (!window._uid) await initUid();
    const recs = await fetchRecords(window._uid);
    renderRecordList(recs);
  } catch (e) {
    console.warn(e);
    listWrap.innerHTML = "<p class='text-sm text-rose-600 text-center py-4'>èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚</p>";
  }
});
document.getElementById("closeModal").addEventListener("click", closeModal);
function closeModal() { modal.classList.add("hidden"); }

// ==== ãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡ ====
document.getElementById("submit").addEventListener("click", async () => {
  const recId = document.getElementById("recordId").value;
  const file = document.getElementById("invoiceFile").files[0];

  if (!recId) { alert("ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
  if (!file) { alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

  showSpinner(); // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã ã‘å…¨ç”»é¢ã‚¹ãƒ”ãƒŠãƒ¼

  const fd = new FormData();
  fd.append("recordId", recId);
  fd.append("file", file, file.name);

  try {
    const res = await fetch(ATTACH_ENDPOINT, { method:"POST", body: fd });
    if (res.ok) {
      alert("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ");
      document.getElementById("invoiceFile").value = "";
      document.getElementById("recordSummary").textContent = "";
      document.getElementById("recordId").value = "";
    } else {
      alert("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: " + (await res.text()));
    }
  } catch (err) {
    alert("ã‚¨ãƒ©ãƒ¼: " + err.message);
  } finally {
    hideSpinner();
  }
});

// ==== UIDåˆæœŸåŒ– ====
async function initUid() {
  const qsUid = new URLSearchParams(location.search).get("uid");
  if (qsUid) { window._uid = qsUid; return; }
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) {
      liff.login({ redirectUri: location.href });
      return;
    }
    const profile = await liff.getProfile();
    window._uid = profile.userId;
  } catch (e) {
    console.warn("LIFF UIDå–å¾—å¤±æ•—ã€‚é–‹ç™ºä¸­ã¯ ?uid=xxx ã‚’URLã«ä»˜ã‘ã¦ãã ã•ã„", e);
    window._uid = null;
  }
}
initUid();
</script>
</body>
</html>
