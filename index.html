<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>請求書アップロード</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root { --safe-bottom: env(safe-area-inset-bottom, 0px); }
    html, body { height: 100%; overscroll-behavior: none; }
    body {
      position: fixed; inset: 0;
      overflow: hidden;
      background: #f1f5f9;
    }
    .hidden { display: none; }
  </style>
</head>
<body>
  <!-- ヘッダー -->
  <header class="bg-[#06C755] text-white px-4 pt-6 pb-3">
    <h1 class="text-base font-semibold">請求書アップロード</h1>
  </header>

  <!-- タブ -->
  <nav id="tabs" class="flex border-b border-slate-300 bg-white">
    <button data-tab="upload" class="flex-1 py-2 border-b-2 border-emerald-600 text-emerald-600 font-semibold">
      請求書アップロード
    </button>
    <button data-tab="history" class="flex-1 py-2 border-b-2 border-transparent text-slate-500 font-semibold">
      履歴
    </button>
  </nav>

  <!-- 本文 -->
  <main class="h-[calc(100svh-64px)] overflow-y-auto overscroll-contain pb-[96px] px-4">

    <!-- ▼アップロードタブ -->
    <section id="tab-upload" class="tab-panel block">
      <section class="bg-white p-4 rounded-lg">
        <h2 class="font-semibold">添付する対象の入荷データを選択してください</h2>
        <div id="recordSummary" class="text-sm text-slate-600 mt-1"></div>
        <button id="openRecordList" type="button"
          class="mt-2 px-4 py-2 rounded bg-emerald-600 text-white font-medium">
          選択
        </button>
        <input type="hidden" id="recordId" />
      </section>

      <section class="bg-white p-4 rounded-lg mt-4">
        <h3 class="font-semibold">請求書ファイル</h3>
        <input id="invoiceFile" type="file" accept="application/pdf,image/*"
          class="h-11 px-3 mt-2 rounded border bg-white file:mr-3 file:px-3 file:py-2 file:rounded file:border file:bg-slate-100 w-full" />
      </section>
    </section>

    <!-- ▼履歴タブ -->
    <section id="tab-history" class="tab-panel hidden">
      <div id="historyArea" class="p-4 text-sm text-slate-700">読み込み中...</div>
    </section>
  </main>

  <!-- フッター -->
  <div class="fixed inset-x-0 bottom-0 bg-white">
    <div class="px-4 pt-2 pb-[calc(8px+var(--safe-bottom))]">
      <button id="submit" class="w-full h-12 rounded bg-emerald-600 text-white font-semibold">
        アップロード
      </button>
    </div>
  </div>

  <!-- モーダル -->
  <div id="recordModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white w-[92%] max-w-md rounded-lg p-4 max-h-[80vh] overflow-y-auto overscroll-contain">
      <h3 class="font-semibold text-lg mb-3">対象入荷データを選択</h3>
      <div id="recordList" class="space-y-2"></div>
      <button id="closeModal" class="mt-4 w-full py-2 rounded border">閉じる</button>
    </div>
  </div>

  <!-- スピナー -->
  <div id="spinner" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white"></div>
  </div>

<script>
const LIFF_ID = "2008144627-bOAmoQo0";
const SEARCH_ENDPOINT = "/api/search";
const ATTACH_ENDPOINT = "/api/invoice-attach";

/* ======= スピナー ======= */
function showSpinner(){ document.getElementById("spinner").classList.remove("hidden"); }
function hideSpinner(){ document.getElementById("spinner").classList.add("hidden"); }

/* ======= LIFF UID ======= */
async function initUid(){
  const qsUid = new URLSearchParams(location.search).get("uid");
  if (qsUid){ window._uid = qsUid; return; }
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()){ liff.login({ redirectUri: location.href }); return; }
    const profile = await liff.getProfile();
    window._uid = profile.userId;
  } catch(e){
    console.warn("LIFF UID取得失敗", e);
    window._uid = null;
  }
}
initUid();

/* ======= レコード取得 ======= */
async function fetchRecords(uid) {
  if (!uid) return [];
  const res = await fetch(`${SEARCH_ENDPOINT}?uid=${encodeURIComponent(uid)}`);
  let data = {};
  try { data = await res.json(); } catch {}
  return Array.isArray(data.records) ? data.records : [];
}
function renderRecordList(records) {
  const wrap = document.getElementById("recordList");
  wrap.innerHTML = "";
  if (!records.length) {
    wrap.innerHTML = "<p class='text-sm text-slate-500 text-center py-4'>対象入荷データはありません</p>";
    return;
  }
  records.forEach(r => {
    const card = document.createElement("button");
    card.type = "button";
    card.className = "w-full text-left p-3 rounded border hover:bg-slate-50";
    const date = r.baseDate || "-";
    const itemsPreview = r.itemTable.slice(0, 2).map(it => {
      const lots = (it.designLot || []).join(",");
      return `${it.itemName} × ${it.qty}${lots ? " [" + lots + "]" : ""}`;
    });
    const more = r.itemTable.length > 2 ? ` 他${r.itemTable.length - 2}件` : "";
    card.innerHTML = `
      <div class="font-semibold text-sm">#${r.recordId}　入荷予定日: ${date}</div>
      <div class="text-xs text-slate-600 mt-1">${itemsPreview.join(" / ")}${more}</div>`;
    card.addEventListener("click", () => {
      document.getElementById("recordId").value = r.recordId;
      document.getElementById("recordSummary").textContent =
        `#${r.recordId} / 入荷予定日:${date} / ${itemsPreview.join(" / ")}${more}`;
      closeModal();
    });
    wrap.appendChild(card);
  });
}

/* ======= モーダル制御 ======= */
const modal = document.getElementById("recordModal");
document.getElementById("openRecordList").addEventListener("click", async () => {
  modal.classList.remove("hidden");
  const listWrap = document.getElementById("recordList");
  listWrap.innerHTML = `
    <div class="flex flex-col items-center justify-center py-6 text-slate-500">
      <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-emerald-600"></div>
      <p class="mt-2 text-sm">読み込み中...</p>
    </div>`;
  try {
    if (!window._uid) await initUid();
    const recs = await fetchRecords(window._uid);
    renderRecordList(recs);
  } catch {
    listWrap.innerHTML = "<p class='text-sm text-rose-600 text-center py-4'>読み込みに失敗しました。</p>";
  }
});
document.getElementById("closeModal").addEventListener("click", ()=>modal.classList.add("hidden"));

/* ======= アップロード ======= */
document.getElementById("submit").addEventListener("click", async () => {
  const recId = document.getElementById("recordId").value;
  const file = document.getElementById("invoiceFile").files[0];
  if (!recId){ alert("レコードを選択してください"); return; }
  if (!file){ alert("ファイルを選択してください"); return; }
  showSpinner();
  const fd = new FormData();
  fd.append("recordId", recId);
  fd.append("file", file, file.name);
  fd.append("origName", file.name);
  try {
    const res = await fetch(ATTACH_ENDPOINT, { method:"POST", body: fd });
    if (res.ok) {
      alert("アップロードしました");
      document.getElementById("invoiceFile").value = "";
      document.getElementById("recordSummary").textContent = "";
      document.getElementById("recordId").value = "";
    } else {
      alert("アップロード失敗: " + (await res.text()));
    }
  } catch (err) {
    alert("エラー: " + err.message);
  } finally {
    hideSpinner();
  }
});

/* ======= タブ切替 ======= */
document.querySelectorAll('#tabs button').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('#tabs button').forEach(b =>
      b.classList.remove('text-emerald-600','border-emerald-600','font-semibold'));
    btn.classList.add('text-emerald-600','border-emerald-600','font-semibold');
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden'));
    document.querySelector(`#tab-${btn.dataset.tab}`).classList.remove('hidden');
    if (btn.dataset.tab === 'history') loadHistory();
  });
});

/* ======= 履歴ロード ======= */
async function loadHistory(){
  const el = document.getElementById("historyArea");
  el.innerHTML = "<p>読み込み中...</p>";
  if (!window._uid){ await initUid(); }
  if (!window._uid){ el.textContent = "UID未登録のため履歴を表示できません"; return; }
  try {
    const resCompany = await fetch(`/api/uid-resolve?uid=${window._uid}`);
    if (!resCompany.ok) throw new Error("companyId取得失敗");
    const { companyId } = await resCompany.json();
    const res = await fetch(`/api/history-list?companyId=${companyId}`);
    if (!res.ok) throw new Error("履歴取得失敗");
    const { items } = await res.json();
    if (!items.length){
      el.innerHTML = "<p class='text-center text-slate-400 py-8'>履歴はまだありません</p>";
      return;
    }
    const rows = items.map(it => {
      const date = new Date(it.createdAt).toLocaleString("ja-JP");
      const planned = it.plannedDate ? new Date(it.plannedDate).toLocaleDateString("ja-JP") : "-";
      const cancelBtn = it.isCanceled
        ? `<span class='text-slate-400'>取消済</span>`
        : `<button class='px-2 py-1 bg-rose-500 text-white text-xs rounded' data-id='${it.recordId}'>取消</button>`;
      return `<tr>
        <td>${date}</td><td>${planned}</td><td>${it.slipNo||"-"}</td>
        <td>${it.qtySum||0}</td><td>${it.status||"-"}</td><td>${cancelBtn}</td>
      </tr>`;
    }).join("");
    el.innerHTML = `
      <table class="w-full border text-sm">
        <thead class="bg-slate-100 text-slate-700">
          <tr><th>受付日時</th><th>入荷予定日</th><th>伝票番号</th><th>数量</th><th>ステータス</th><th>操作</th></tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>`;
    el.querySelectorAll("button[data-id]").forEach(btn => {
      btn.addEventListener("click", async () => {
        if (!confirm("取消しますか？")) return;
        const id = btn.dataset.id;
        const res = await fetch("/api/history-cancel", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ recordId:id, uid:window._uid })
        });
        if (res.ok){ alert("取消しました"); loadHistory(); }
        else { alert("取消失敗: " + (await res.text())); }
      });
    });
  } catch(e){
    el.textContent = "履歴の読み込みに失敗しました";
  }
}
</script>
</body>
</html>

